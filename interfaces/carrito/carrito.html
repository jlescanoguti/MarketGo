<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Carrito de Compras - MarketGo</title>
  <link rel="stylesheet" href="carrito.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
  <header class="navbar">
    <div class="logo">üõí <span>MarketGo</span></div>
    <nav class="nav-actions">
      <button onclick="history.back()" class="btn-nav" aria-label="Volver a la p√°gina anterior">‚Üê Volver</button>
      <button onclick="location.href='../pago/pago.html'" class="btn-nav" aria-label="Proceder al pago">Pagar ‚Üí</button>
    </nav>
  </header>

  <main class="container">
    <h1>Tu Carrito de Compras</h1>

    <p class="subtitle">
      Revisa tus productos antes de proceder al pago
    </p>

    <!-- Carrito vac√≠o -->
    <section id="emptyCart" class="empty-cart" style="display: none;" aria-label="Carrito vac√≠o">
      <div class="icon" aria-hidden="true">üõí</div>
      <h3>Tu carrito est√° vac√≠o</h3>
      <p>Agrega algunos productos para comenzar tu compra</p>
      <a href="../categorias/categorias.html" class="btn-continue" aria-label="Continuar comprando">Continuar Comprando</a>
    </section>

    <!-- Carrito con productos -->
    <section id="cartWithItems" class="cart-container" aria-label="Productos en el carrito">
      <div class="cart-items">
        <div id="cartItemsList" role="list" aria-label="Lista de productos">
          <!-- Los items se cargar√°n din√°micamente -->
        </div>
      </div>

      <aside class="cart-summary">
        <h2>Resumen de Compra</h2>
        <div class="summary-details">
          <div class="summary-row">
            <span>Subtotal:</span>
            <span id="subtotal">S/ 0.00</span>
          </div>
          <div class="summary-row">
            <span>Env√≠o:</span>
            <span id="shipping">S/ 5.00</span>
          </div>
          <div class="summary-row">
            <span>Descuento:</span>
            <span id="discount">S/ 0.00</span>
          </div>
          <div class="summary-row total">
            <span>Total:</span>
            <span id="total">S/ 0.00</span>
          </div>
        </div>
        
        <!-- Informaci√≥n adicional -->
        <div class="delivery-info">
          <div class="delivery-header">
            <span aria-hidden="true">üöö</span>
            <strong>Entrega estimada:</strong>
          </div>
          <div class="delivery-details">
            15-25 minutos ‚Ä¢ Gratis en pedidos mayores a S/ 30
          </div>
        </div>
        
        <button id="checkoutBtn" onclick="proceedToCheckout()" class="btn-checkout" disabled aria-label="Proceder al pago">
          Proceder al Pago
        </button>
        
        <div class="continue-shopping">
          <a href="../categorias/categorias.html" aria-label="Continuar comprando">
            ‚Üê Continuar Comprando
          </a>
        </div>
      </aside>
    </section>
  </main>

  <script>
    let cart = [];
    const shippingCost = 5.00;
    const freeShippingThreshold = 30.00;

    // Cargar carrito al iniciar
    document.addEventListener('DOMContentLoaded', function() {
      loadCart();
      updateCartDisplay();
      setupAccessibility();
    });

    // Cargar carrito desde localStorage
    function loadCart() {
      const savedCart = localStorage.getItem('marketGoCart');
      if (savedCart) {
        cart = JSON.parse(savedCart);
      }
      
      // Si no hay productos en el carrito, agregar algunos de ejemplo
      if (cart.length === 0) {
        cart = [
          {
            id: 1,
            name: 'Papa Amarilla',
            price: 3.50,
            store: 'El Ahorro',
            image: '../../shared/assets/images/papa.jpg',
            quantity: 2
          },
          {
            id: 2,
            name: 'Camote Amarillo',
            price: 2.80,
            store: 'La Esquina',
            image: '../../shared/assets/images/camote.jpg',
            quantity: 1
          },
          {
            id: 3,
            name: 'Leche Gloria 1L',
            price: 8.50,
            store: 'La Lechera',
            image: '../../shared/assets/images/camote.jpg',
            quantity: 1
          }
        ];
        saveCart();
      }
    }

    // Guardar carrito en localStorage
    function saveCart() {
      localStorage.setItem('marketGoCart', JSON.stringify(cart));
    }

    // Actualizar display del carrito
    function updateCartDisplay() {
      const cartItemsList = document.getElementById('cartItemsList');
      const emptyCart = document.getElementById('emptyCart');
      const cartWithItems = document.getElementById('cartWithItems');
      const checkoutBtn = document.getElementById('checkoutBtn');

      if (cart.length === 0) {
        emptyCart.style.display = 'block';
        cartWithItems.style.display = 'none';
        checkoutBtn.disabled = true;
        return;
      }

      emptyCart.style.display = 'none';
      cartWithItems.style.display = 'grid';
      checkoutBtn.disabled = false;

      // Limpiar lista actual
      cartItemsList.innerHTML = '';

      // Agregar cada item
      cart.forEach((item, index) => {
        const cartItem = createCartItemElement(item, index);
        cartItemsList.appendChild(cartItem);
      });

      updateTotals();
    }

    // Crear elemento de item del carrito
    function createCartItemElement(item, index) {
      const cartItem = document.createElement('div');
      cartItem.className = 'cart-item';
      cartItem.dataset.index = index;
      cartItem.setAttribute('role', 'listitem');
      cartItem.setAttribute('aria-label', `${item.name} - Cantidad: ${item.quantity}`);

      const subtotal = (item.price * item.quantity).toFixed(2);
      
      cartItem.innerHTML = `
        <img src="${item.image}" alt="${item.name}" loading="lazy">
        <div class="item-details">
          <h3>${item.name}</h3>
          <p class="store">Minimarket "${item.store}"</p>
          <p class="price">S/ ${item.price.toFixed(2)} x Unidad</p>
          <div class="item-subtotal">
            Subtotal: <strong>S/ ${subtotal}</strong>
          </div>
        </div>
        <div class="quantity-controls" role="group" aria-label="Controles de cantidad">
          <button class="btn-quantity" onclick="updateQuantity(${index}, -1)" ${item.quantity <= 1 ? 'disabled' : ''} aria-label="Reducir cantidad">-</button>
          <span class="quantity" aria-live="polite">${item.quantity}</span>
          <button class="btn-quantity" onclick="updateQuantity(${index}, 1)" aria-label="Aumentar cantidad">+</button>
        </div>
        <button class="btn-remove" onclick="removeItem(${index})" aria-label="Eliminar ${item.name} del carrito">√ó</button>
      `;

      return cartItem;
    }

    // Actualizar cantidad de un item
    function updateQuantity(index, change) {
      if (cart[index]) {
        const newQuantity = cart[index].quantity + change;
        
        if (newQuantity <= 0) {
          removeItem(index);
          return;
        }
        
        cart[index].quantity = newQuantity;
        saveCart();
        updateCartDisplay();
        
        // Feedback t√°ctil en m√≥viles
        if ('vibrate' in navigator) {
          navigator.vibrate(30);
        }
      }
    }

    // Eliminar item del carrito
    function removeItem(index) {
      if (cart[index]) {
        const item = cart[index];
        const cartItem = document.querySelector(`[data-index="${index}"]`);
        
        if (cartItem) {
          cartItem.classList.add('removing');
          setTimeout(() => {
            cart.splice(index, 1);
            saveCart();
            updateCartDisplay();
            showNotification(`${item.name} eliminado del carrito`, 'info');
          }, 300);
        }
        
        // Feedback t√°ctil en m√≥viles
        if ('vibrate' in navigator) {
          navigator.vibrate(50);
        }
      }
    }

    // Actualizar totales
    function updateTotals() {
      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      const shipping = subtotal >= freeShippingThreshold ? 0 : shippingCost;
      const discount = subtotal >= 50 ? subtotal * 0.1 : 0; // 10% de descuento en pedidos mayores a S/ 50
      const total = subtotal + shipping - discount;

      document.getElementById('subtotal').textContent = `S/ ${subtotal.toFixed(2)}`;
      document.getElementById('shipping').textContent = shipping === 0 ? 'Gratis' : `S/ ${shipping.toFixed(2)}`;
      document.getElementById('discount').textContent = `S/ ${discount.toFixed(2)}`;
      document.getElementById('total').textContent = `S/ ${total.toFixed(2)}`;

      // Actualizar informaci√≥n de env√≠o
      const deliveryInfo = document.querySelector('.delivery-info');
      if (shipping === 0) {
        deliveryInfo.style.background = 'linear-gradient(135deg, #e8f5e9, #c8e6c9)';
        deliveryInfo.querySelector('.delivery-details').textContent = '¬°Env√≠o gratis! ‚Ä¢ Entrega en 15-25 minutos';
      } else {
        deliveryInfo.style.background = 'linear-gradient(135deg, #fff3e0, #ffe0b2)';
        deliveryInfo.querySelector('.delivery-details').textContent = `15-25 minutos ‚Ä¢ Agrega S/ ${(freeShippingThreshold - subtotal).toFixed(2)} m√°s para env√≠o gratis`;
      }
    }

    // Proceder al checkout
    function proceedToCheckout() {
      if (cart.length > 0) {
        showNotification('Redirigiendo al pago...', 'success');
        setTimeout(() => {
          location.href = '../pago/pago.html';
        }, 1500);
      }
    }

    // Mostrar notificaciones
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? 'linear-gradient(135deg, #4caf50, #2e7d32)' : 'linear-gradient(135deg, #2196f3, #1976d2)'};
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        z-index: 10000;
        font-weight: 600;
        transform: translateX(100%);
        transition: transform 0.3s ease;
        max-width: 300px;
        word-wrap: break-word;
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.transform = 'translateX(0)';
      }, 100);
      
      setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (document.body.contains(notification)) {
            document.body.removeChild(notification);
          }
        }, 300);
      }, 3000);
    }

    // Configurar accesibilidad
    function setupAccessibility() {
      // Navegaci√≥n por teclado
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          history.back();
        }
      });

      // Detectar orientaci√≥n del dispositivo
      function handleOrientation() {
        if (window.innerWidth < 768) {
          document.body.classList.toggle('landscape', window.innerHeight < window.innerWidth);
        }
      }

      window.addEventListener('orientationchange', handleOrientation);
      window.addEventListener('resize', handleOrientation);
      handleOrientation();
    }

    // Prevenir zoom en doble tap en iOS
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = (new Date()).getTime();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, false);
  </script>

  <style>
    /* Estilos adicionales para mejoras de responsive */
    .item-subtotal {
      margin-top: 8px;
      font-size: 0.9rem;
      color: #666;
    }

    .item-subtotal strong {
      color: var(--verde-oscuro);
    }

    /* Mejoras para m√≥viles */
    @media (max-width: 768px) {
      .cart-item {
        position: relative;
      }

      .btn-remove {
        position: absolute;
        top: 8px;
        right: 8px;
        z-index: 10;
      }

      .quantity-controls {
        margin-top: 12px;
      }
    }

    @media (max-width: 480px) {
      .item-subtotal {
        font-size: 0.8rem;
      }

      .delivery-info {
        padding: 12px;
      }

      .delivery-header {
        font-size: 0.9rem;
      }

      .delivery-details {
        font-size: 0.8rem;
      }
    }

    /* Mejoras de accesibilidad */
    .cart-item:focus {
      outline: 2px solid var(--verde-claro);
      outline-offset: 2px;
    }

    /* Prevenir scroll horizontal */
    html, body {
      overflow-x: hidden;
      width: 100%;
    }

    /* Mejoras para pantallas muy peque√±as */
    @media (max-width: 360px) {
      .item-subtotal {
        font-size: 0.75rem;
      }

      .delivery-info {
        padding: 10px;
      }

      .delivery-header {
        font-size: 0.85rem;
      }

      .delivery-details {
        font-size: 0.75rem;
      }
    }

    /* Estados de carga */
    .cart-item.loading {
      opacity: 0.7;
      pointer-events: none;
    }

    /* Mejoras de animaci√≥n */
    .cart-item {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .cart-item:hover {
      transform: translateY(-2px);
    }

    /* Mejoras de contraste */
    .summary-row {
      color: #333;
    }

    .summary-row.total {
      color: var(--verde-oscuro);
    }
  </style>
</body>
</html>
